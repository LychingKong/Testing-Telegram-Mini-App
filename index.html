<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Telegram Shop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica,
          Arial, sans-serif;
        background: #f5f5f5;
        color: #333;
      }

      .hidden {
        display: none !important;
      }

      /* Header */
      .header {
        background: white;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
        padding: 16px;
      }

      .header-with-back {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .back-btn {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 4px;
        display: flex;
        align-items: center;
      }

      .header h1 {
        font-size: 24px;
        font-weight: 700;
      }

      .user-welcome {
        font-size: 14px;
        color: #666;
        margin-top: 4px;
      }

      /* Products Grid */
      .products-grid {
        padding: 16px;
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 16px;
        padding-bottom: 100px;
      }

      .product-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        overflow: hidden;
      }

      .product-content {
        padding: 16px;
      }

      .product-emoji {
        font-size: 64px;
        text-align: center;
        margin-bottom: 12px;
      }

      .product-name {
        font-weight: 600;
        font-size: 18px;
        margin-bottom: 4px;
      }

      .product-desc {
        font-size: 14px;
        color: #666;
        margin-bottom: 12px;
      }

      .product-price {
        font-size: 28px;
        font-weight: 700;
        color: #2481cc;
        margin-bottom: 12px;
      }

      .product-controls {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .quantity-controls {
        display: flex;
        align-items: center;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
      }

      .qty-btn {
        background: white;
        border: none;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 18px;
        transition: background 0.2s;
      }

      .qty-btn:hover {
        background: #f5f5f5;
      }

      .qty-btn:disabled {
        opacity: 0.3;
        cursor: not-allowed;
      }

      .qty-display {
        padding: 8px 16px;
        min-width: 48px;
        text-align: center;
        font-weight: 600;
        border-left: 1px solid #ddd;
        border-right: 1px solid #ddd;
      }

      .add-to-cart-btn {
        flex: 1;
        background: #2481cc;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .add-to-cart-btn:hover {
        background: #1a6bb3;
      }

      .add-to-cart-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      /* Cart Footer */
      .cart-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #ddd;
        padding: 16px;
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
      }

      .cart-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
      }

      .cart-items-count {
        display: flex;
        align-items: center;
        gap: 8px;
        font-weight: 600;
      }

      .cart-total {
        font-size: 20px;
        font-weight: 700;
        color: #2481cc;
      }

      .view-cart-btn {
        width: 100%;
        background: #2481cc;
        color: white;
        border: none;
        padding: 16px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .view-cart-btn:hover {
        background: #1a6bb3;
      }

      /* Checkout Page */
      .checkout-container {
        padding: 16px;
        padding-bottom: 32px;
      }

      .checkout-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 16px;
        margin-bottom: 16px;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .cart-item {
        display: flex;
        gap: 12px;
        padding-bottom: 12px;
        margin-bottom: 12px;
        border-bottom: 1px solid #eee;
      }

      .cart-item:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
      }

      .cart-item-emoji {
        font-size: 36px;
      }

      .cart-item-details {
        flex: 1;
      }

      .cart-item-name {
        font-weight: 600;
        margin-bottom: 4px;
      }

      .cart-item-price {
        font-size: 14px;
        color: #666;
      }

      .cart-item-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .cart-qty-btn {
        background: none;
        border: 1px solid #ddd;
        border-radius: 4px;
        width: 28px;
        height: 28px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .cart-qty-display {
        min-width: 32px;
        text-align: center;
        font-weight: 600;
      }

      .cart-item-right {
        text-align: right;
      }

      .cart-item-subtotal {
        font-weight: 700;
        margin-bottom: 4px;
      }

      .remove-btn {
        font-size: 12px;
        color: #e74c3c;
        background: none;
        border: none;
        cursor: pointer;
        text-decoration: underline;
      }

      .order-total {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 16px;
        border-top: 2px solid #eee;
        margin-top: 16px;
      }

      .order-total-label {
        font-size: 18px;
        font-weight: 600;
      }

      .order-total-amount {
        font-size: 28px;
        font-weight: 700;
        color: #2481cc;
      }

      /* Form */
      .form-group {
        margin-bottom: 16px;
      }

      .form-label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
        font-weight: 500;
        margin-bottom: 8px;
        color: #555;
      }

      .form-input {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.2s;
      }

      .form-input:focus {
        outline: none;
        border-color: #2481cc;
        box-shadow: 0 0 0 3px rgba(36, 129, 204, 0.1);
      }

      textarea.form-input {
        resize: vertical;
        min-height: 80px;
        font-family: inherit;
      }

      .place-order-btn {
        width: 100%;
        background: #27ae60;
        color: white;
        border: none;
        padding: 18px;
        border-radius: 8px;
        font-size: 18px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .place-order-btn:hover {
        background: #229954;
      }

      .place-order-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      /* Success Page */
      .success-container {
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 16px;
      }

      .success-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 32px;
        max-width: 400px;
        text-align: center;
      }

      .success-icon {
        font-size: 64px;
        color: #27ae60;
        margin-bottom: 16px;
      }

      .success-title {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
      }

      .success-message {
        color: #666;
        margin-bottom: 24px;
        line-height: 1.5;
      }

      .continue-shopping-btn {
        width: 100%;
        background: #2481cc;
        color: white;
        border: none;
        padding: 16px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .continue-shopping-btn:hover {
        background: #1a6bb3;
      }

      @media (max-width: 600px) {
        .products-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Products Page -->
    <div id="productsPage">
      <div class="header">
        <h1>Shop</h1>
        <div class="user-welcome" id="userWelcome"></div>
      </div>
      <div class="products-grid" id="productsGrid"></div>
      <div class="cart-footer hidden" id="cartFooter">
        <div class="cart-summary">
          <div class="cart-items-count">
            üõí <span id="cartItemCount">0</span> items
          </div>
          <div class="cart-total" id="cartTotal">$0.00</div>
        </div>
        <button class="view-cart-btn" onclick="goToCheckout()">
          View Cart & Checkout
        </button>
      </div>
    </div>

    <!-- Checkout Page -->
    <div id="checkoutPage" class="hidden">
      <div class="header">
        <div class="header-with-back">
          <button class="back-btn" onclick="goToProducts()">‚Üê</button>
          <h1>Checkout</h1>
        </div>
      </div>
      <div class="checkout-container">
        <div class="checkout-section">
          <div class="section-title">üì¶ Order Summary</div>
          <div id="checkoutItems"></div>
          <div class="order-total">
            <span class="order-total-label">Total:</span>
            <span class="order-total-amount" id="checkoutTotal">$0.00</span>
          </div>
        </div>

        <div class="checkout-section">
          <div class="section-title">Shipping Information</div>
          <form id="orderForm">
            <div class="form-group">
              <label class="form-label">üë§ Full Name *</label>
              <input
                type="text"
                class="form-input"
                id="customerName"
                placeholder="John Doe"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label">üìû Phone Number *</label>
              <input
                type="tel"
                class="form-input"
                id="customerPhone"
                placeholder="+1234567890"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label">üìç Delivery Address *</label>
              <textarea
                class="form-input"
                id="customerAddress"
                placeholder="123 Main St, City, Country"
                required
              ></textarea>
            </div>
          </form>
        </div>

        <button
          class="place-order-btn"
          id="placeOrderBtn"
          onclick="placeOrder()"
        >
          Place Order - $0.00
        </button>
      </div>
    </div>

    <!-- Success Page -->
    <div id="successPage" class="hidden">
      <div class="success-container">
        <div class="success-card">
          <div class="success-icon">‚úì</div>
          <h1 class="success-title">Order Placed Successfully!</h1>
          <p class="success-message">
            Thank you for your order. We'll contact you soon to confirm delivery
            details.
          </p>
          <button class="continue-shopping-btn" onclick="goToProducts()">
            Continue Shopping
          </button>
        </div>
      </div>
    </div>

    <script>
      // Configuration
      const GOOGLE_SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzz3AjCigZCV2Y41rydwWNZ7QKzUwXV_OevWdSPWIS79fvgXi1yICTLeUV5SGQ-WbQbBQ/exec";

      // Our product catalog - an array of product objects
      // Each product has: id, name, price, image (emoji), and description
      const PRODUCTS = [
        {
          id: 1,
          name: "Premium Headphones",
          price: 79.99,
          image: "üéß",
          description: "High-quality wireless headphones",
        },
        {
          id: 2,
          name: "Smart Watch",
          price: 199.99,
          image: "‚åö",
          description: "Fitness tracking smartwatch",
        },
        {
          id: 3,
          name: "Wireless Earbuds",
          price: 49.99,
          image: "üéµ",
          description: "Compact Bluetooth earbuds",
        },
        {
          id: 4,
          name: "Phone Case",
          price: 19.99,
          image: "üì±",
          description: "Protective phone case",
        },
        {
          id: 5,
          name: "Portable Charger",
          price: 34.99,
          image: "üîã",
          description: "10000mAh power bank",
        },
        {
          id: 6,
          name: "Bluetooth Speaker",
          price: 59.99,
          image: "üîä",
          description: "Waterproof portable speaker",
        },
      ];

      // ========================================
      // GLOBAL VARIABLES (Our App's Memory)
      // ========================================

      // cart stores products that have been added to cart
      // Example: { 1: 2, 3: 1 } means product 1 has quantity 2, product 3 has quantity 1
      let cart = {};

      // productQuantities tracks the number selected before adding to cart
      // Example: { 1: 3 } means user has selected 3 units of product 1
      let productQuantities = {};

      // Stores information about the Telegram user (if available)
      let telegramUser = null;

      // ========================================
      // TELEGRAM INTEGRATION
      // ========================================

      // Check if this app is running inside Telegram
      if (window.Telegram && window.Telegram.WebApp) {
        const tg = window.Telegram.WebApp;

        // Tell Telegram the app is ready
        tg.ready();

        // Expand the app to full screen
        tg.expand();

        // Try to get the user's Telegram information
        if (tg.initDataUnsafe && tg.initDataUnsafe.user) {
          telegramUser = tg.initDataUnsafe.user;

          // Display a welcome message with the user's first name
          const welcomeElement = document.getElementById("userWelcome");
          welcomeElement.textContent =
            "Welcome, " + telegramUser.first_name + "!";
        }

        // Match the background color with Telegram's theme
        document.body.style.backgroundColor = tg.backgroundColor || "#f5f5f5";
      }

      // ========================================
      // INITIALIZATION
      // ========================================

      // This function runs when the page first loads
      function init() {
        renderProducts(); // Display all products on the page
        updateCartFooter(); // Update the cart footer (will be hidden initially)
      }

      // ========================================
      // PRODUCT DISPLAY FUNCTIONS
      // ========================================

      // This function creates HTML for all products and displays them
      function renderProducts() {
        // Get the container where products will be displayed
        const grid = document.getElementById("productsGrid");

        // Create HTML for each product
        let productsHTML = "";

        // Loop through each product in our catalog
        for (let i = 0; i < PRODUCTS.length; i++) {
          const product = PRODUCTS[i];

          // Get the current quantity for this product (default to 0 if not set)
          const currentQuantity = productQuantities[product.id] || 0;

          // Format the price to always show 2 decimal places
          const formattedPrice = product.price.toFixed(2);

          // Determine if minus button should be disabled
          const minusDisabled = currentQuantity === 0 ? "disabled" : "";

          // Determine if add to cart button should be disabled
          const addDisabled = currentQuantity === 0 ? "disabled" : "";

          // Build the HTML for this product card
          productsHTML += `
            <div class="product-card">
              <div class="product-content">
                <div class="product-emoji">${product.image}</div>
                <div class="product-name">${product.name}</div>
                <div class="product-desc">${product.description}</div>
                <div class="product-price">$${formattedPrice}</div>
                <div class="product-controls">
                  <div class="quantity-controls">
                    <button class="qty-btn" onclick="updateProductQuantity(${product.id}, -1)" ${minusDisabled}>‚àí</button>
                    <div class="qty-display" id="qty-${product.id}">${currentQuantity}</div>
                    <button class="qty-btn" onclick="updateProductQuantity(${product.id}, 1)">+</button>
                  </div>
                  <button class="add-to-cart-btn" onclick="addToCart(${product.id})" ${addDisabled}>Add to Cart</button>
                </div>
              </div>
            </div>
          `;
        }

        // Put all the product HTML into the grid container
        grid.innerHTML = productsHTML;
      }

      // ========================================
      // PRODUCT QUANTITY FUNCTIONS
      // ========================================

      // This function updates the quantity when user clicks + or - buttons
      // productId: which product to update
      // delta: how much to change (+1 or -1)
      function updateProductQuantity(productId, delta) {
        // Get the current quantity (or 0 if not set)
        let currentQty = productQuantities[productId] || 0;

        // Calculate new quantity
        let newQty = currentQty + delta;

        // Make sure quantity never goes below 0
        if (newQty < 0) {
          newQty = 0;
        }

        // Save the new quantity
        productQuantities[productId] = newQty;

        // Update the display to show the new quantity
        const qtyDisplay = document.getElementById("qty-" + productId);
        qtyDisplay.textContent = newQty;

        // Find the product card container
        const card = qtyDisplay.closest(".product-card");

        // Find the minus button (first qty-btn)
        const minusBtn = card.querySelector(".qty-btn:first-child");

        // Find the "Add to Cart" button
        const addBtn = card.querySelector(".add-to-cart-btn");

        // Disable minus button if quantity is 0
        if (newQty === 0) {
          minusBtn.disabled = true;
          addBtn.disabled = true;
        } else {
          minusBtn.disabled = false;
          addBtn.disabled = false;
        }
      }

      // ========================================
      // CART FUNCTIONS
      // ========================================

      // This function adds the selected quantity to the cart
      function addToCart(productId) {
        // Get how many items the user selected
        const selectedQuantity = productQuantities[productId] || 0;

        // Only add to cart if quantity is greater than 0
        if (selectedQuantity > 0) {
          // Add to cart (or increase existing quantity)
          if (cart[productId]) {
            // Product already in cart, add to existing quantity
            cart[productId] = cart[productId] + selectedQuantity;
          } else {
            // New product, add it to cart
            cart[productId] = selectedQuantity;
          }

          // Reset the product quantity selector back to 0
          productQuantities[productId] = 0;

          // Refresh the products display
          renderProducts();

          // Update the cart footer to show new totals
          updateCartFooter();

          // Give haptic feedback if in Telegram (phone vibration)
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.HapticFeedback.impactOccurred("medium");
          }
        }
      }

      // This function calculates totals and updates the cart footer
      function updateCartFooter() {
        // Calculate total number of items in cart
        let totalItems = 0;

        // Loop through cart and add up all quantities
        for (let productId in cart) {
          totalItems = totalItems + cart[productId];
        }

        // Calculate total price
        let totalPrice = 0;

        // Loop through cart items
        for (let productId in cart) {
          const quantity = cart[productId];

          // Find the product details
          let product = null;
          for (let i = 0; i < PRODUCTS.length; i++) {
            if (PRODUCTS[i].id === parseInt(productId)) {
              product = PRODUCTS[i];
              break;
            }
          }

          // Add to total price
          if (product) {
            totalPrice = totalPrice + product.price * quantity;
          }
        }

        // Update the cart item count display
        document.getElementById("cartItemCount").textContent = totalItems;

        // Update the cart total price display
        document.getElementById("cartTotal").textContent =
          "$" + totalPrice.toFixed(2);

        // Show or hide the cart footer
        const cartFooter = document.getElementById("cartFooter");

        if (totalItems > 0) {
          // Cart has items, show the footer
          cartFooter.classList.remove("hidden");
        } else {
          // Cart is empty, hide the footer
          cartFooter.classList.add("hidden");
        }
      }

      // ========================================
      // NAVIGATION FUNCTIONS
      // ========================================

      // Navigate to the checkout page
      function goToCheckout() {
        // Hide the products page
        document.getElementById("productsPage").classList.add("hidden");

        // Show the checkout page
        document.getElementById("checkoutPage").classList.remove("hidden");

        // Display the cart items on checkout page
        renderCheckout();
      }

      // Navigate back to the products page
      function goToProducts() {
        // Hide checkout and success pages
        document.getElementById("checkoutPage").classList.add("hidden");
        document.getElementById("successPage").classList.add("hidden");

        // Show products page
        document.getElementById("productsPage").classList.remove("hidden");
      }

      // ========================================
      // CHECKOUT PAGE FUNCTIONS
      // ========================================

      // Display cart items on the checkout page
      function renderCheckout() {
        const itemsContainer = document.getElementById("checkoutItems");

        // Calculate total price (same logic as updateCartFooter)
        let totalPrice = 0;
        for (let productId in cart) {
          const quantity = cart[productId];
          let product = null;
          for (let i = 0; i < PRODUCTS.length; i++) {
            if (PRODUCTS[i].id === parseInt(productId)) {
              product = PRODUCTS[i];
              break;
            }
          }
          if (product) {
            totalPrice = totalPrice + product.price * quantity;
          }
        }

        // Build HTML for each cart item
        let cartItemsHTML = "";

        for (let productId in cart) {
          const quantity = cart[productId];

          // Find the product
          let product = null;
          for (let i = 0; i < PRODUCTS.length; i++) {
            if (PRODUCTS[i].id === parseInt(productId)) {
              product = PRODUCTS[i];
              break;
            }
          }

          if (product) {
            // Calculate subtotal for this item
            const subtotal = product.price * quantity;

            // Build HTML for this cart item
            cartItemsHTML += `
              <div class="cart-item">
                <div class="cart-item-emoji">${product.image}</div>
                <div class="cart-item-details">
                  <div class="cart-item-name">${product.name}</div>
                  <div class="cart-item-price">$${product.price.toFixed(2)} each</div>
                </div>
                <div class="cart-item-controls">
                  <button class="cart-qty-btn" onclick="updateCartQuantity(${product.id}, -1)">‚àí</button>
                  <span class="cart-qty-display">${quantity}</span>
                  <button class="cart-qty-btn" onclick="updateCartQuantity(${product.id}, 1)">+</button>
                </div>
                <div class="cart-item-right">
                  <div class="cart-item-subtotal">$${subtotal.toFixed(2)}</div>
                  <button class="remove-btn" onclick="removeFromCart(${product.id})">Remove</button>
                </div>
              </div>
            `;
          }
        }

        // Display all cart items
        itemsContainer.innerHTML = cartItemsHTML;

        // Update the total price displays
        document.getElementById("checkoutTotal").textContent =
          "$" + totalPrice.toFixed(2);
        document.getElementById("placeOrderBtn").textContent =
          "Place Order - $" + totalPrice.toFixed(2);
      }

      // Update quantity of an item already in the cart
      function updateCartQuantity(productId, delta) {
        // Get current quantity
        let currentQty = cart[productId] || 0;

        // Calculate new quantity
        let newQty = currentQty + delta;

        // If new quantity is 0 or less, remove item from cart
        if (newQty <= 0) {
          delete cart[productId];
        } else {
          // Update the quantity
          cart[productId] = newQty;
        }

        // Refresh the checkout display
        renderCheckout();

        // Update the cart footer
        updateCartFooter();
      }

      // Remove an item completely from the cart
      function removeFromCart(productId) {
        // Delete the product from cart
        delete cart[productId];

        // Refresh displays
        renderCheckout();
        updateCartFooter();

        // If cart is now empty, go back to products page
        let cartIsEmpty = true;
        for (let id in cart) {
          cartIsEmpty = false;
          break;
        }

        if (cartIsEmpty) {
          goToProducts();
        }
      }

      // ========================================
      // ORDER SUBMISSION
      // ========================================

      // This function submits the order to Google Sheets
      async function placeOrder() {
        // Get the form values
        const name = document.getElementById("customerName").value.trim();
        const phone = document.getElementById("customerPhone").value.trim();
        const address = document.getElementById("customerAddress").value.trim();

        // Check if all required fields are filled
        if (!name || !phone || !address) {
          alert("Please fill in all required fields");
          return;
        }

        // Disable the button and show processing state
        const btn = document.getElementById("placeOrderBtn");
        btn.disabled = true;
        btn.textContent = "Processing...";

        // Calculate total price
        let totalPrice = 0;
        for (let productId in cart) {
          const quantity = cart[productId];
          let product = null;
          for (let i = 0; i < PRODUCTS.length; i++) {
            if (PRODUCTS[i].id === parseInt(productId)) {
              product = PRODUCTS[i];
              break;
            }
          }
          if (product) {
            totalPrice = totalPrice + product.price * quantity;
          }
        }

        // Create a unique order ID
        const timestamp = Date.now(); // Current time in milliseconds
        const randomStr = Math.random().toString(36).substr(2, 9); // Random string
        const orderId = "ORD-" + timestamp + "-" + randomStr;

        // Build the order items array
        let orderItems = [];
        for (let productId in cart) {
          const quantity = cart[productId];

          // Find the product
          let product = null;
          for (let i = 0; i < PRODUCTS.length; i++) {
            if (PRODUCTS[i].id === parseInt(productId)) {
              product = PRODUCTS[i];
              break;
            }
          }

          if (product) {
            orderItems.push({
              productId: productId,
              productName: product.name,
              quantity: quantity,
              price: product.price,
              subtotal: product.price * quantity,
            });
          }
        }

        // Create the complete order data object
        const orderData = {
          orderId: orderId,
          customer: {
            name: name,
            phone: phone,
            address: address,
          },
          items: orderItems,
          total: totalPrice,
          telegramUser: telegramUser
            ? {
                id: telegramUser.id,
                username: telegramUser.username || "",
                firstName: telegramUser.first_name || "",
                lastName: telegramUser.last_name || "",
              }
            : null,
          timestamp: new Date().toISOString(), // Current date/time in ISO format
        };

        // Send the order to Google Sheets
        try {
          // Make the HTTP request
          await fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", // Required for Google Apps Script
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(orderData), // Convert object to JSON string
          });

          // Order sent successfully!

          // Clear the cart
          cart = {};

          // Clear the form fields
          document.getElementById("customerName").value = "";
          document.getElementById("customerPhone").value = "";
          document.getElementById("customerAddress").value = "";

          // Hide checkout page and show success page
          document.getElementById("checkoutPage").classList.add("hidden");
          document.getElementById("successPage").classList.remove("hidden");

          // Update cart footer (will hide it since cart is empty)
          updateCartFooter();

          // Give success haptic feedback if in Telegram
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred(
              "success",
            );
          }
        } catch (error) {
          // Something went wrong
          console.error("Order error:", error);
          alert("Failed to submit order. Please try again.");

          // Give error haptic feedback if in Telegram
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.HapticFeedback.notificationOccurred("error");
          }
        } finally {
          // Re-enable the button (whether success or error)
          btn.disabled = false;
          btn.textContent = "Place Order - $" + totalPrice.toFixed(2);
        }
      }

      // ========================================
      // START THE APP
      // ========================================

      // When the page loads, run the init function
      init();
    </script>
  </body>
</html>
